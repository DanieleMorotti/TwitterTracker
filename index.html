<!DOCTYPE html>
<html lang="it">
	<head>
		<title>Titolo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
		<script>
			var streamingInterval = null;
            
			function streamStart() {
				let keyword = $('#stream').val();
				if (keyword) {
					$.ajax({
						method: "GET",
						url: 'streamStart',
                        data: {
                            word: keyword,
                        },
                        
						success: (data) => {
							$('#tweets').empty();
                            
                            if(streamingInterval)
                                clearInterval(streamingInterval);
                            
							streamingInterval = setInterval(() => { streamUpdate(keyword) }, 500);
						},
                        
						error: (xhr, ajaxOptions, thrownError) => {
							console.log("streamStart: " + xhr.status + ' - ' + thrownError);
						}
					});
				}
			}
            
            function streamStop() {
                if(streamingInterval)
                    clearInterval(streamingInterval);
                
                $.ajax({
						method: "GET",
						url: 'streamStop',
                        
						success: (data) => {
						},
                        
						error: (xhr, ajaxOptions, thrownError) => {
                            console.log("streamStop: " + xhr.status + ' - ' + thrownError);
						}
                });
            }
            
			function streamUpdate(keyword) {
				console.log('stream update');
				$.ajax({
					url: '/streamUpdate',
					method: 'GET',
					success: (data) => {
						$("#tweets-stream").html("");
						for (let i = 0; i < data.length; i++) {
							$("#tweets-stream").append('<p>' + data[i].text + '</p>');
						}
					},
                    error: function (xhr, ajaxOptions, thrownError) {
                        console.log("streamUpdate: " + xhr.status + ' - ' + thrownError);
                    }
				});
			}
			
			function geo_localized(){
				let keyword = $('#search_geo').val();
				let loc = $('#coordinates').val();
				$.ajax({
					method: 'GET',
					url: '/geo',
					data: {
						word: keyword,
						location: loc
					},
					success: (data) => {
						$("#tweets-geo").html("");
						for (let i = 0; i < data.length; i++) {
							$("#tweets-geo").append('<p>Città: ' + data[i].city +' Coordinate: '+ data[i].coordinates + '</p>');
						}
						console.log("success");
					},
               error: function (xhr, ajaxOptions, thrownError) {
                  console.log("streamUpdate: " + xhr.status + ' - ' + thrownError);
               }
				});				
			}
            
			function search() {
				let keyword = $('#search').val();
				$.ajax({
					method: "GET",
					url: "/search",
					data: {
						word: keyword,
					},
                    
					success: (data) => {
						$("#tweets-search").html("");
						for (let i = 0; i < data.length; i++) {
							var url = "https://twitter.com/"+ data[i].username + "/status/"+ data[i].id;
							localStorage.setItem(i, url);
							$("#tweets-search").append(`<div class="messages"><h3>${data[i].user}</h3><p>${data[i].data}</p><p>${data[i].text}</p><button onclick=show(${i}) id="btn" data-toggle="modal" data-target="#myModal" >Show</button>`);
						}
					},
                    
					error: (xhr, ajaxOptions, thrownError) => {
                        console.log("search: " + xhr.status + ' - ' + thrownError);
					}
				});
			}

			function show(index){
				console.log('premuto')
				let url = localStorage.getItem(index);
				$('#tweetContent').empty();
				$('#tweetContent').append(`<blockquote class="twitter-tweet"><a href=${url}>Tweet</a></blockquote>  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"><\/script>`);
			}
		</script>
		<link rel="stylesheet" href="index.css">
	</head>
	<body>
		<label for="search">Search by word: </label>
		<input type="text" name="search" id="search" onkeyup="function press(event) {if (event.keyCode === 13) search()}; press(event)"/>
		<button onclick="search()">Search</button>
        <h4>Search Results</h4>
		<div id="tweets-search">	
		</div>
		<hr>
        
       <label for="stream">Start stream by word: </label>
		<input type="text" name="stream" id="stream" />
		<button onclick="streamStart()">Start</button>
		<button onclick="streamStop()">Stop</button>
        <h4>Stream Results</h4>
		<div id="tweets-stream">
		</div>
		<hr>
		
		<label for="stream">Search this word: </label>
		<input type="text" name="geo_search" id="search_geo" />
		<label for="stream">In this coordinates(lat,long,radius)[Es.(45.4773,9.1815,1000km)]: </label>
		<input type="text" name="geo_search_coord" id="coordinates" />
		<button onclick="geo_localized()">Prova geo</button>
       <h4>Geolocalized tweets Results</h4>
		<div id="tweets-geo">
		</div>
		
		<!-- modal for displaying tweets -->
		<div class="modal fade" id="myModal" role="dialog">
			<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<div id="tweetContent"></div>
				</div>
				<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
			
			</div>
		</div>
			
		  
	</body>
</html>