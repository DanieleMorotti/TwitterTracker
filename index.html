<!DOCTYPE html>
<html lang="it">
	<head>
		<title>Fraydrum</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
		<script>
			var streamingInterval = null;
            
			function streamStart() {
				let keyword = $('#stream').val();
				if (keyword) {
					$.ajax({
						method: "GET",
						url: 'streamStart',
                        data: {
                            word: keyword,
                        },
                        
						success: (data) => {
							$('#tweets').empty();
                            
                            if(streamingInterval)
                                clearInterval(streamingInterval);
                            
							streamingInterval = setInterval(() => { streamUpdate(keyword) }, 500);
						},
                        
						error: (xhr, ajaxOptions, thrownError) => {
							console.log("streamStart: " + xhr.status + ' - ' + thrownError);
						}
					});
				}
			}
            
            function streamStop() {
                if(streamingInterval)
                    clearInterval(streamingInterval);
                $.ajax({
						method: "GET",
						url: 'streamStop',
                        
						success: (data) => {
						},
                        
						error: (xhr, ajaxOptions, thrownError) => {
                            console.log("streamStop: " + xhr.status + ' - ' + thrownError);
						}
                });
            }
            
			function streamUpdate(keyword) {
                let reg = new RegExp(keyword, 'gi');
				$.ajax({
					url: '/streamUpdate',
					method: 'GET',
					success: (data) => {
						$("#tweets-search").empty();
						$("#tweets-search").append('<h4>' + data.length + ' Streaming Tweets Results</h4>');
                        for (let i = 0; i < data.length; i++) {
                            var url = "https://twitter.com/" + data[i].username + "/status/" + data[i].id;
                            $(`<div class="messages"><h3>${data[i].user}</h3>
								<p>${data[i].data}</p><p>${data[i].text.replace(reg, '<mark>$&</mark>')}</p>
								<button onclick=show("${url}") id="btn" data-toggle="modal" data-target="#myModal" >Show</button>`).
								insertAfter('#tweets-search > h4');
                        }
					},
                    error: function (xhr, ajaxOptions, thrownError) {
                        console.log("streamUpdate: " + xhr.status + ' - ' + thrownError);
                    }
				});
			}
			
            
			function search(word,loc) {
				let query = {keyword: word};
				if(loc) query['location'] = loc;
				$.ajax({
					method: "GET",
					url: "/search",
					data: query,
					success: (data) => {
                        let reg = new RegExp(query.keyword, 'gi');
						$("#tweets-search").empty();
                        $("#tweets-search").append('<h4>' + data.length + ' Search Tweets Results</h4>');
                        window.scrollTo(0, 0);

						for (let i = 0; i < data.length; i++) {
							var url = "https://twitter.com/" + data[i].username + "/status/" + data[i].id;
							let div = $(`<div class="messages"><h3>${data[i].user}</h3>
											<p>${data[i].data}</p><p>${data[i].text.replace(reg, '<mark>$&</mark>')}</p>
												<button onclick=show("${url}") id="btn" data-toggle="modal" data-target="#myModal" >Show</button>`);
                     
							if(data[i].city || data[i].coordinates){
								let cityAndCoord = `<p>Città: ${data[i].city} Coordinate: ${data[i].coordinates} </p>`;
								$(cityAndCoord).insertBefore(div.find('button'));
								console.log(i);
							}
							$("#tweets-search").append(div);
						}
						if (data.length < 1) {
                            $("#tweets-search").append('<h5>No results for the specified query</h5>');
                        }
					},
                    
					error: (xhr, ajaxOptions, thrownError) => {
                        console.log("search: " + xhr.status + ' - ' + thrownError);
					}
				});
			}

			function dispatch_search() {
				let word = $('#search').val();
				let loc = $('#coordinates').val();

				if (!word) {
					alert("Non hai inserito la parola");
				} else {
					if (streamingInterval) { streamStop(); }
					search(word,loc);
                }
            }

			function show(url){
				$('#tweetContent').empty();
				$('#tweetContent').append(`<blockquote class="twitter-tweet"><a href="${url}">Tweet</a></blockquote>  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"><\/script>`);
			}
		</script>
		<link rel="stylesheet" href="/static/css/index.css">
	</head>
	<body>
		<!--
	<label for="search">Search by word: </label>
	<input type="text" name="search" id="search" onkeyup="function press(event) {if (event.keyCode === 13) search()}; press(event)"/>
	<button onclick="search()">Search</button>
	<h4>Search Results</h4>
	<div id="tweets-search">
	</div>
	<hr>
	-->
		<div class="filter-bar">
			<div id="stream-div">
				<label for="stream">Start stream by word: </label>
				<input type="text" name="stream" id="stream" onkeyup="function press(event) {if (event.keyCode === 13) streamStart()}; press(event)"/>
				<button onclick="streamStart()">Start</button>
				<button onclick="streamStop()">Stop</button>
			</div>
			<div id="search-div">
				<label for="stream">Search this word: </label>
				<input type="text" name="search" id="search" onkeyup="function press(event) {if (event.keyCode === 13) dispatch_search()}; press(event)" />
				<label for="stream">In this coordinates (lat, long, radius): </label>
				<input type="text" name="geo_search_coord" id="coordinates" placeholder="e.g. 45.4773,9.1815,1000km" size="22"/>
				<button onclick="dispatch_search()">Search</button>
			</div>
		</div>
		<div id="tweets-search">
		</div>

		<!-- modal for displaying tweets -->
		<div class="modal fade" id="myModal" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
					</div>
					<div class="modal-body">
						<div id="tweetContent"></div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>

			</div>
		</div>


	</body>
</html>
